#!/usr/bin/python
# -*- coding: UTF-8 -*-
# import sqlite3
import time
import pyodbc
from douyin import *


UnknownUserList = ['103929541462', '58547828857', '102727441549', '104642090603', '93662240049', '98190344083', '69658898270', '103596482856', '85947527634', '93639597018', '63198891601', '72218128474', '58122876084', '60660491934', '77742182368', '64450731047', '60458746792', '105401337223', '92367376398', '92678632522', '94636635323', '100476457239', '73808727481', '71285867810', '65855388748', '60964107784', '68725786278', '68726067201', '65623120649', '90114148152', '102902614378', '67813847009', '72402244606', '98105728159', '61829663290', '103879775379', '106016900613', '79490113476', '96572147733', '87569400516', '101756257035', '104404560076', '57634179688', '97775252738', '92742728072', '102086842235', '75410139817', '98185139361', '60377440650', '55133686625', '100923379290', '59134924564', '105636893282', '58884961899', '103738655078', '100063254541', '69428321224', '59448560399', '99223765160', '67036849232', '92081591708', '104715369553', '101389560117', '61842757466', '88378643703', '73031483931', '70556865392', '102553015129', '98047456186', '61274463836', '56611946537', '18238681142', '70762636090', '71134765752', '98919704729', '58835902614', '94509393044', '95431195801', '99561642428', '85593529588', '63826197037', '99852016743', '76209088177', '62552808925', '62424863891', '101126758868', '60274221076', '63011943866', '105449313780', '73866984849', '68520686494', '102630645178', '21449745845', '66935968891', '66935532660', '82273746721', '94067206761', '62357585372', '72813559849', '74898413158', '101620652841', '63182708192', '94090840269', '57372481798', '58652222895', '70967947912', '97111131121', '62794858137', '102444518597', '99217421062', '75433358696', '101682140154', '63600820564', '90139446566', '69515109724', '51530521676', '99943374957', '94692516661', '102978580740', '97462482390', '98029099213', '58065869590', '105836723010', '98890510072', '61561840151', '82918181850', '59201865911', '104691878641', '12848933781', '67523916786', '67524096869', '67523613735', '67522942316', '58322013782', '54349401719', '59385699635', '59385768841', '59385769100', '59384948501', '59385176141', '59386718836', '59383955378', '59384489948', '59384669219', '59384310660', '66507865044', '72791329317', '59809293040', '59809727055', '59811071027', '59811071233', '59814422819', '59813488809', '59818572689', '59817830819',
'59808921242', '76082726430', '73373234827', '77087465678', '61138508882', '103728033246', '101260681385', '63505756254', '105731429442', '93562402612', '103597630803', '103459659785', '60487000250', '97591281510', '86028318842', '104525323588', '75663280751', '82548683603', '84049982035', '54998331782', '104393397837', '96338016874', '100064535953', '84858351324', '104373871945', '56929666340', '60434422867', '97821731528', '105889086177', '98026995919', '75310339785', '105126678048', '87480460421', '71348640230', '96561105464', '98099688421', '79167684974', '105442219755', '101875550267', '102704519648', '71267513574', '57506814611', '67886447120', '54599200788']


dy = DouyinTool()
# 获取用户关注列表
async def getUserFavorite(user):
  saveUserDataNum = 0
  # 时间
  Time = time.time()
  logging.info("start get follow list")
  # noSearchList = []
  userList = dy.get_follow_list(user)
  # 链接数据库
  conn = pyodbc.connect(r'DRIVER={SQL Server Native Client 11.0};SERVER=localhost;DATABASE=Douyin;UID=PUGE;PWD=mmit7750')
  c = conn.cursor()
  async for video in userList:
    # 从数据库中查找结果
    cursor = c.execute(f"select * from SIMPLE with(updlock) where DOUYIN_ID = '{video['user_id']}'")
    res = cursor.fetchall()
    # 判断结果是否存在
    if (len(res) == 0):
      # 去除换行符
      video['nickname'] = video['nickname'].replace('\n', '')
      video['nickname'] = video['nickname'].replace("'", "''")
      video['signature'] = video['signature'].replace('\n', '')
      video['signature'] = video['signature'].replace("'", "''")
      # 插入用户数据
      # print("Opened database successfully")
      # noSearchList.append({user_id: video['user_id'], nickname: video['nickname'], signature: video['signature']})
      c.execute(f"INSERT INTO SIMPLE (DOUYIN_ID, NAME, SIGNA, BIRTHDAY, GET_TIME) \
        VALUES ({video['user_id']}, '{video['nickname']}', '{video['signature']}', '{video['birthday']}', {int(Time)} )");
      # print("Records created successfully")
      saveUserDataNum += 1
      # 用户池上限100防止溢出
      if (len(UnknownUserList) < 200):
        UnknownUserList.append(video['user_id'])
  UnknownUserList.remove(user)
  # print(str(user))
  logging.info(f"user {str(user)} clear! save data number {str(saveUserDataNum)} strip")
  logging.info(f"current user pool:{str(UnknownUserList)}")
  conn.commit()
  conn.close()

save_dir = 'C:/Users/my/Documents/GitHub/douyin-hack/data/video'
concurrency = 20
user = '69528936131'
action = 'favorite'
follow = False
# trio.run(main, user, action, follow, save_dir, concurrency)
while len(UnknownUserList) > 0:
  trio.run(getUserFavorite, UnknownUserList[0])
logging.info('all over!')